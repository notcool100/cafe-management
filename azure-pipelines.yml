trigger:
  branches:
    include:
      - main
  paths:
    include:
      - fe/**
      - be/**

pool:
  name: 'Astro'

variables:
  nodeVersion: '24.x'

stages:
- stage: BuildFrontend 
  displayName: 'Build Frontend'
  jobs:
  - job: BuildFrontendJob
    displayName: 'Build Next.js App'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Install Node.js'
    
    # - script: |
    #     echo "Building shared packages..."
    #     cd packages/nepali-date-converter
    #     pnpm install
    #     pnpm run build
    #   displayName: 'Build Shared Packages'

    - script: |
        cd fe
        npm install -g pnpm
        pnpm install
        
        # Ensure environment files are properly set up
        echo "Setting up environment files for build"
        cp fe.env .env
      displayName: 'Install Frontend Dependencies'
    
    - script: |
        cd fe
        echo "Running TypeScript check with skipLibCheck flag"
        pnpm type-check || true
      displayName: 'Run TypeScript Check (Non-blocking)'
    
    - script: |
        cd fe
        echo "Building frontend application with TypeScript errors ignored"
        NODE_OPTIONS=--max_old_space_size=4096 pnpm run build
      displayName: 'Build Frontend Application'
    
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: 'fe'
        includeRootFolder: false
        archiveType: 'tar'
        tarCompression: 'gz'
        archiveFile: '$(Build.ArtifactStagingDirectory)/cafe-frontend.tar.gz'
        replaceExistingArchive: true
    
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/cafe-frontend.tar.gz'
        ArtifactName: 'cafe-frontend'
        publishLocation: 'Container'

- stage: BuildBackend
  displayName: 'Build Backend'
  jobs:
  - job: BuildBackendJob
    displayName: 'Build Node.js API'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
      displayName: 'Install Node.js'
    
    # - script: |
    #     echo "Building shared packages..."
    #     cd packages/nepali-date-converter
    #     pnpm install
    #     pnpm run build
    #   displayName: 'Build Shared Packages'

    - script: |
        cd be
        npm install -g pnpm
        pnpm install
      displayName: 'Install Backend Dependencies'

    - script: |
        cd be
        pnpm prisma:generate
      displayName: 'Generate Prisma Client'
    
    - script: |
        cd be
        pnpm run build
      displayName: 'Build Backend Application'
    
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: 'be'
        includeRootFolder: false
        archiveType: 'tar'
        tarCompression: 'gz'
        archiveFile: '$(Build.ArtifactStagingDirectory)/cafe-backend.tar.gz'
        replaceExistingArchive: true
    
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/cafe-backend.tar.gz'
        ArtifactName: 'cafe-backend'
        publishLocation: 'Container'
- stage: DeployDev
  displayName: 'Deploy to Development'
  dependsOn: 
    - BuildFrontend
    - BuildBackend
  condition: and(succeeded('BuildFrontend'), succeeded('BuildBackend'), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: DeployFrontendDev
    displayName: 'Deploy Frontend to Dev'
    steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'cafe-frontend'
        downloadPath: '$(System.ArtifactsDirectory)'

    - script: |
         echo "Listing downloaded files:"
         ls -la $(System.ArtifactsDirectory)
         
         # Create a clean temporary directory for extraction
         TEMP_DIR=$(mktemp -d)
         echo "Created temporary directory: $TEMP_DIR"
         
         # Extract to temporary directory first
         tar -xzf $(System.ArtifactsDirectory)/cafe-frontend/cafe-frontend.tar.gz -C $TEMP_DIR
         
         # Ensure target directory exists with proper permissions
         mkdir -p /var/www/cafe-management/frontend
         
         # Remove existing .next directory if it exists to avoid permission issues
         if [ -d "/var/www/cafe-management/frontend/.next" ]; then
           rm -rf /var/www/cafe-management/frontend/.next
         fi
         
         # Copy files from temp directory to target directory
         rsync -av --exclude='.next/cache' $TEMP_DIR/ /var/www/cafe-management/frontend/
         
         # Clean up temporary directory
         rm -rf $TEMP_DIR
         
         echo "Frontend deployed to /var/www/cafe-management/frontend"
      displayName: 'Extract Frontend Build'

    - script: |
        # Check if we're running as the astroagent user
        if [ "$(whoami)" = "astroagent" ]; then
          # Running as astroagent, no need for sudo
          export PATH=$PATH:/home/astroagent/.nvm/versions/node/v24.4.1/bin
          export PM2_HOME=/home/astroagent/.pm2
          cd /var/www/cafe-management/frontend
          pm2 restart cafe-frontend || pm2 start npm --name "cafe-frontend" --cwd /var/www/cafe-management/frontend -- start
          pm2 save
        else
          # We need to use a different approach since sudo is not available
          echo "Current user is not astroagent and sudo is not available. Please configure the pipeline to run as the astroagent user."
          echo "Alternatively, add the pipeline user to the sudoers file with the appropriate permissions."
          exit 1
        fi
      displayName: 'Restart Frontend with PM2'

  - job: DeployBackendDev
    displayName: 'Deploy Backend to Dev'
    steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'cafe-backend'
        downloadPath: '$(System.ArtifactsDirectory)'

    - script: |
        echo "Listing downloaded files:"
        ls -la $(System.ArtifactsDirectory)
        
        # Create a clean temporary directory for extraction
        TEMP_DIR=$(mktemp -d)
        echo "Created temporary directory: $TEMP_DIR"
        
        # Extract to temporary directory first
        tar -xzf $(System.ArtifactsDirectory)/cafe-backend/cafe-backend.tar.gz -C $TEMP_DIR
        
        # Ensure target directory exists with proper permissions
        mkdir -p /var/www/cafe-management/backend
        
        # Copy files from temp directory to target directory
        rsync -av $TEMP_DIR/ /var/www/cafe-management/backend/
        
        # Clean up temporary directory
        rm -rf $TEMP_DIR
        
        echo "Backend deployed to /var/www/cafe-management/backend"
      displayName: 'Extract Backend Build'
    - script: |
        if [ "$(whoami)" = "astroagent" ]; then
          export PATH=$PATH:/home/astroagent/.nvm/versions/node/v24.4.1/bin
          cd /var/www/cafe-management/backend

          # Install prod deps (or full deps if you need)
          npm install -g pnpm
          pnpm install --frozen-lockfile

          # Regenerate prisma client on the server
          pnpm prisma:generate

          # Optional but recommended if you use migrations
          # pnpm prisma:migrate:deploy
        else
          echo "Not running as astroagent"
          exit 1
        fi
      displayName: 'Install deps + Generate Prisma on VPS'
    - script: |
        # Check if we're running as the astroagent user
        if [ "$(whoami)" = "astroagent" ]; then
          # Running as astroagent, no need for sudo
          export PATH=$PATH:/home/astroagent/.nvm/versions/node/v24.4.1/bin
          export PM2_HOME=/home/astroagent/.pm2
          cd /var/www/cafe-management/backend
          pm2 restart cafe-backend || pm2 start npm --name "cafe-backend" --cwd /var/www/cafe-management/backend -- start
          pm2 save
        else
          # We need to use a different approach since sudo is not available
          echo "Current user is not astroagent and sudo is not available. Please configure the pipeline to run as the astroagent user."
          echo "Alternatively, add the pipeline user to the sudoers file with the appropriate permissions."
          exit 1
        fi
      displayName: 'Restart Backend with PM2'
